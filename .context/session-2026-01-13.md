# Context Save: Printer Activity Monitor Rebuild

**Session Date:** 2026-01-13
**Project:** PrinterActivityMonitor iOS App Rebuild
**Phase Completed:** Phase 2 - Home Assistant Integration

## Project Overview

Rebuilding a 3D printer monitoring iOS app as a Bambu Handy replacement for LAN-only/developer mode users. Uses Home Assistant's ha_bambulab integration for real-time printer data.

## Architecture Decisions

### Stack
- **Backend:** Node.js + Express + TypeScript
- **iOS:** SwiftUI with @Observable (iOS 17+, Swift 6)
- **HA Connection:** WebSocket API (real-time events)
- **Auth:** HA Token Passthrough
- **Repository:** Monorepo (`/server`, `/ios`)
- **Database:** JSON file store (SQLite avoided due to Node.js 25 compatibility)

### Feature Tiers
- **Tier 1:** Rich notifications, Live Activities, Dynamic Island, Print History, Dashboard
- **Tier 2:** Printer Controls, Auto-Discovery, AMS Filament Tracking
- **Tier 3:** Multi-Printer Support, Advanced Controls
- **Future:** Camera feed, Print cost estimation, Widgets

## Completed Work

### Phase 1: Foundation (Complete)
- Server: package.json, tsconfig, Express app, health endpoint, auth routes
- iOS: App structure, TabView, Design System (Liquid Aurora theme)
- Tests: Health and auth endpoint tests

### Phase 2: HA Integration (Complete)
- Server:
  - `src/types/homeassistant.ts` - WebSocket API types
  - `src/services/HomeAssistant.ts` - WebSocket service with auth/reconnection
  - `src/services/EntityDiscovery.ts` - Printer/AMS pattern matching
  - `src/routes/discovery.ts` - `/api/discovery/scan` endpoint
  - `tests/discovery.test.ts` - All tests passing (10 passed)

- iOS:
  - `Core/Models/PrinterState.swift` - PrintStatus, PrinterModel enums
  - `Core/Storage/SettingsStorage.swift` - @Observable persistence
  - `Core/Services/APIClient.swift` - Discovery endpoint integration
  - `Features/Setup/ConnectionSetupView.swift` - HA credential entry
  - `Features/Setup/PrinterSelectionView.swift` - Discovered printer selection
  - `DesignSystem/Theme.swift` - Liquid Aurora color system

## Key File Locations

```
/server/
├── src/
│   ├── index.ts              # Express app entry
│   ├── config/               # Environment, database
│   ├── types/homeassistant.ts
│   ├── services/
│   │   ├── HomeAssistant.ts  # WebSocket client
│   │   └── EntityDiscovery.ts
│   └── routes/
│       ├── auth.ts
│       └── discovery.ts
└── tests/
    ├── health.test.ts
    ├── auth.test.ts
    └── discovery.test.ts

/ios/PrinterMonitor/PrinterMonitor/
├── App/
│   ├── PrinterMonitorApp.swift
│   └── ContentView.swift     # Root TabView
├── Core/
│   ├── Models/PrinterState.swift
│   ├── Services/APIClient.swift
│   └── Storage/SettingsStorage.swift
├── Features/
│   ├── Dashboard/DashboardView.swift
│   ├── History/HistoryView.swift
│   ├── Settings/SettingsView.swift
│   ├── Setup/ConnectionSetupView.swift
│   └── Setup/PrinterSelectionView.swift
└── DesignSystem/Theme.swift
```

## Entity Discovery Patterns

Printer sensors discovered via suffixes:
- `_print_progress`, `_print_status`, `_current_layer`
- `_total_layer_count`, `_nozzle_temperature`, `_bed_temperature`
- `_remaining_time`, `_subtask_name`, `_speed_profile`, `_stage`

AMS trays: `sensor.{prefix}_tray_{1-4}`

Model detection: x1c, x1, p1s, p1p, a1, a1m, h2s, h2d

## Design System (Liquid Aurora)

```swift
// Primary accent - Celestial Cyan
static let accent = Color(red: 0.35, green: 0.78, blue: 0.98)

// Aurora gradient
static let auroraStart = Color(red: 0.35, green: 0.78, blue: 0.98)
static let auroraMid = Color(red: 0.55, green: 0.6, blue: 0.95)
static let auroraEnd = Color(red: 0.45, green: 0.85, blue: 0.75)
```

## Next Steps (Phase 3)

1. Real-time WebSocket subscription on server
2. PrintMonitor service for state change detection
3. Dashboard view with live printer data
4. Pull-to-refresh functionality

## Plan Documents

- `/docs/plans/2026-01-13-app-rebuild-design.md` - Full architecture design
- `/docs/plans/2026-01-13-phase1-foundation.md` - Phase 1 tasks
- `/docs/plans/2026-01-13-phase2-ha-integration.md` - Phase 2 tasks

## Commands

```bash
# Server
cd server && npm run dev      # Start development server
cd server && npm run test:run # Run tests
cd server && npm run build    # TypeScript compile

# iOS
cd ios/PrinterMonitor && xcodegen generate  # Regenerate Xcode project
```

## User Preferences

- Progress ring should show time left + ETA over percentage
- Debug menu for testing notifications with mock data
- Dynamic printer/AMS discovery (HA names aren't consistent)
- Free Apple Developer account during development (APNs requires paid $99/year)
